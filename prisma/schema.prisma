datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  // previewFeatures = []
}

// 暂时注释掉 dbml generator，可能存在版本兼容问题
// generator dbml {
//   provider = "prisma-dbml-generator"
//   output   = "./dbml"
// }

model User {
  id            String          @id @default(cuid())
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  email         String          @unique
  password      String
  firstname     String?
  lastname      String?
  posts         Post[]
  role          Role
  media         Media[] // 用户上传的媒体文件
  comments      Comment[] // 用户发表的评论
  searchHistory SearchHistory[] // 用户的搜索历史
}

model Post {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本内容
  title   String  @db.VarChar(255) // 标题
  slug    String  @unique @default(cuid()) // URL 友好标识符（先用默认值）
  excerpt String? @db.VarChar(500) // 摘要/简介
  content String? @db.Text // 正文内容

  // 发布状态
  published   Boolean    @default(false) // 是否发布（兼容旧字段）
  status      PostStatus @default(DRAFT) // 文章状态
  publishedAt DateTime? // 发布时间

  // 作者关系
  author   User?   @relation(fields: [authorId], references: [id])
  authorId String?

  // 分类关系
  category   Category? @relation(fields: [categoryId], references: [id])
  categoryId String?

  // 标签关系（多对多）
  tags PostTag[]

  // SEO 元数据（一对一）
  meta PostMeta?

  // 评论关系
  comments Comment[]

  // 统计字段
  viewCount Int @default(0) // 浏览次数

  @@index([categoryId])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

enum Role {
  ADMIN
  USER
}

/// 文章状态枚举
enum PostStatus {
  DRAFT // 草稿
  PUBLISHED // 已发布
  SCHEDULED // 定时发布
  ARCHIVED // 已归档
  TRASH // 回收站
}

// ============================================
// 分类系统（树形结构）
// ============================================

/// 分类模型 - 支持无限层级的树形结构
model Category {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本信息
  name        String  @db.VarChar(100) // 分类名称
  slug        String  @unique // URL 友好的标识符（如：frontend）
  description String? @db.Text // 分类描述
  icon        String? // 图标（可选）
  color       String? // 颜色标识（如：#3B82F6）
  order       Int     @default(0) // 排序权重

  // 树形结构：自引用关系
  parentId String? // 父分类 ID（null 表示顶级分类）
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryTree")

  // 关联的文章
  posts Post[]

  // 统计字段
  postCount Int @default(0) // 该分类下的文章数量

  // 索引优化
  @@index([slug]) // slug 用于 URL 查询，需要索引
  @@index([parentId]) // 树形查询时经常用 parentId，需要索引
  @@index([order]) // 排序时需要索引
}

// ============================================
// 标签系统（多对多关系）
// ============================================

/// 标签模型
model Tag {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本信息
  name        String  @unique @db.VarChar(50) // 标签名称（唯一）
  slug        String  @unique // URL 友好的标识符
  description String? @db.VarChar(255) // 标签描述
  color       String? // 标签颜色（如：#10B981）

  // 关联的文章（通过中间表）
  posts PostTag[]

  // 统计字段
  postCount Int @default(0) // 该标签下的文章数量

  // 索引优化
  @@index([slug])
  @@index([name])
}

/// 文章-标签关联表（中间表）
/// 实现 Post 和 Tag 的多对多关系
model PostTag {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 关联的文章
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 关联的标签
  tagId String
  tag   Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  // 组合唯一约束：一篇文章不能重复添加同一个标签
  @@unique([postId, tagId])
  // 索引优化
  @@index([postId])
  @@index([tagId])
}

// ============================================
// SEO 元数据系统
// ============================================

/// 文章 SEO 元数据
/// 一对一关系：每篇文章最多有一条 SEO 元数据
model PostMeta {
  id     String @id @default(cuid())
  postId String @unique
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // SEO 字段
  metaTitle       String? @db.VarChar(70) // SEO 标题（建议 60-70 字符）
  metaDescription String? @db.VarChar(160) // SEO 描述（建议 150-160 字符）
  metaKeywords    String? @db.VarChar(255) // 关键词
  canonicalUrl    String? // 规范 URL

  // Open Graph（社交媒体分享）
  ogTitle       String? @db.VarChar(95) // Open Graph 标题
  ogDescription String? @db.VarChar(200) // Open Graph 描述
  ogImage       String? // Open Graph 图片 URL

  // Twitter Card
  twitterCard        String? @default("summary_large_image") // Twitter 卡片类型
  twitterTitle       String? @db.VarChar(70) // Twitter 标题
  twitterDescription String? @db.VarChar(200) // Twitter 描述
  twitterImage       String? // Twitter 图片 URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 媒体库系统
// ============================================

/// 媒体类型枚举
enum MediaType {
  IMAGE // 图片
  VIDEO // 视频
  AUDIO // 音频
  DOCUMENT // 文档
  OTHER // 其他
}

/// 媒体文件模型
/// 存储上传的图片、视频、文档等文件
model Media {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本信息
  filename    String  @db.VarChar(255) // 原始文件名
  title       String? @db.VarChar(255) // 媒体标题（用户可自定义）
  description String? @db.Text // 媒体描述
  altText     String? @db.VarChar(255) // 图片 alt 文本（SEO）

  // 文件信息
  type     MediaType // 媒体类型
  mimeType String    @db.VarChar(100) // MIME 类型（如：image/jpeg）
  size     Int // 文件大小（字节）
  path     String    @db.VarChar(500) // 文件存储路径
  url      String    @db.VarChar(500) // 访问 URL

  // 图片特定信息（仅 IMAGE 类型）
  width        Int? // 图片宽度
  height       Int? // 图片高度
  thumbnailUrl String? @db.VarChar(500) // 缩略图 URL

  // 上传者信息
  uploaderId String
  uploader   User   @relation(fields: [uploaderId], references: [id])

  // 元数据（可扩展）
  metadata Json? // 存储额外的元数据（如：EXIF、视频时长等）

  // 索引优化
  @@index([uploaderId])
  @@index([type])
  @@index([createdAt])
}

// ============================================
// 评论系统
// ============================================

/// 评论状态枚举
enum CommentStatus {
  PENDING // 待审核
  APPROVED // 已批准
  REJECTED // 已拒绝
  SPAM // 垃圾评论
}

/// 评论模型
/// 支持嵌套回复（树形结构）和审核功能
model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 评论内容
  content String @db.Text // 评论正文

  // 关联的文章
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 评论作者
  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  // 树形结构：嵌套回复（自引用关系）
  parentId String? // 父评论 ID（null 表示顶级评论）
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  // 审核状态
  status CommentStatus @default(PENDING) // 默认待审核

  // 互动统计
  likes Int @default(0) // 点赞数

  // 索引优化
  @@index([postId]) // 查询文章评论时需要
  @@index([authorId]) // 查询用户评论时需要
  @@index([parentId]) // 查询嵌套回复时需要
  @@index([status]) // 筛选审核状态时需要
  @@index([createdAt]) // 按时间排序时需要
}

// ============================================
// 搜索系统
// ============================================

/// 搜索历史模型
/// 记录用户的搜索行为，用于搜索建议和热门搜索统计
model SearchHistory {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 搜索关键词
  query String @db.VarChar(200) // 搜索查询

  // 搜索用户（可选，未登录用户为 null）
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 搜索结果统计
  resultsCount Int @default(0) // 搜索结果数量

  // 搜索来源（用于分析）
  source String? @db.VarChar(50) // 搜索来源：web、mobile、api 等

  // 索引优化
  @@index([query]) // 搜索建议时需要
  @@index([userId]) // 查询用户搜索历史时需要
  @@index([createdAt]) // 按时间统计时需要
}
