// ============================================
// CMS Blog 后台管理系统 - 完整数据库设计
// ============================================
// 这是一个教学文件，展示完整的 CMS 数据库架构
// 稍后我们会逐步将其迁移到 schema.prisma
// ============================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================
// 用户和权限系统
// ============================================

/// 用户表
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本信息
  email     String   @unique
  password  String
  firstname String?
  lastname  String?
  avatar    String?  // 头像 URL
  bio       String?  // 个人简介

  // 角色和状态
  role      Role     @default(USER)
  status    UserStatus @default(ACTIVE)

  // 关系
  posts              Post[]
  comments           Comment[]
  approvalRequests   ApprovalRequest[] @relation("Requester")
  approvalActions    ApprovalAction[]
  mediaUploads       Media[]
  postRevisions      PostRevision[]

  @@index([email])
  @@index([role])
}

/// 用户状态枚举
enum UserStatus {
  ACTIVE      // 活跃
  INACTIVE    // 未激活
  SUSPENDED   // 已暂停
  DELETED     // 已删除
}

/// 用户角色枚举
enum Role {
  ADMIN       // 管理员 - 完全权限
  EDITOR      // 编辑 - 可编辑所有内容
  AUTHOR      // 作者 - 只能编辑自己的内容
  USER        // 普通用户 - 只能评论
}

// ============================================
// 文章核心系统
// ============================================

/// 文章表（扩展版）
model Post {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本内容
  title     String   @db.VarChar(255)
  slug      String   @unique  // URL 友好的标识符
  excerpt   String?  @db.VarChar(500)  // 摘要
  content   String?  @db.Text

  // 特色图片
  featuredImageId String?
  featuredImage   Media?  @relation(fields: [featuredImageId], references: [id])

  // 状态和发布
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?  // 发布时间
  scheduledAt   DateTime?  // 定时发布时间

  // 作者
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])

  // 分类和标签
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  tags       PostTag[]

  // 多语言
  languageId    String?
  language      Language? @relation(fields: [languageId], references: [id])
  translations  PostTranslation[]

  // SEO
  meta      PostMeta?

  // 关系
  comments      Comment[]
  revisions     PostRevision[]
  views         PostView[]
  approvalRequest ApprovalRequest?

  // 统计字段
  viewCount     Int @default(0)
  commentCount  Int @default(0)

  @@index([slug])
  @@index([status])
  @@index([authorId])
  @@index([categoryId])
  @@index([publishedAt])
}

/// 文章状态枚举
enum PostStatus {
  DRAFT           // 草稿
  PENDING_REVIEW  // 待审核
  APPROVED        // 已批准（待发布）
  PUBLISHED       // 已发布
  SCHEDULED       // 定时发布
  ARCHIVED        // 已归档
  TRASH           // 回收站
}

/// 文章 SEO 元数据
model PostMeta {
  id     String @id @default(cuid())
  postId String @unique
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)

  // SEO 字段
  metaTitle       String? @db.VarChar(70)   // SEO 标题（建议 60-70 字符）
  metaDescription String? @db.VarChar(160)  // SEO 描述（建议 150-160 字符）
  metaKeywords    String? @db.VarChar(255)  // 关键词
  canonicalUrl    String?                   // 规范 URL
  ogTitle         String? @db.VarChar(95)   // Open Graph 标题
  ogDescription   String? @db.VarChar(200)  // Open Graph 描述
  ogImage         String?                   // Open Graph 图片 URL
  twitterCard     String? @default("summary_large_image")  // Twitter 卡片类型

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// 分类系统（树形结构）
// ============================================

/// 分类表（支持无限层级）
model Category {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本信息
  name        String   @db.VarChar(100)
  slug        String   @unique
  description String?  @db.Text
  icon        String?  // 图标
  color       String?  // 颜色标识
  order       Int      @default(0)  // 排序

  // 树形结构
  parentId String?
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")

  // 关系
  posts Post[]

  // 统计
  postCount Int @default(0)

  @@index([slug])
  @@index([parentId])
  @@index([order])
}

// ============================================
// 标签系统
// ============================================

/// 标签表
model Tag {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 基本信息
  name        String   @unique @db.VarChar(50)
  slug        String   @unique
  description String?  @db.VarChar(255)
  color       String?  // 标签颜色

  // 关系
  posts PostTag[]

  // 统计
  postCount Int @default(0)

  @@index([slug])
  @@index([name])
}

/// 文章-标签关联表（多对多）
model PostTag {
  id        String   @id @default(cuid())
  postId    String
  tagId     String
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// ============================================
// 媒体库系统
// ============================================

/// 媒体文件表
model Media {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 文件信息
  filename     String                // 原始文件名
  path         String                // 存储路径
  url          String                // 访问 URL
  mimeType     String                // MIME 类型
  size         Int                   // 文件大小（字节）
  width        Int?                  // 图片宽度
  height       Int?                  // 图片高度

  // 分类
  type         MediaType

  // 元数据
  alt          String?               // 替代文本
  caption      String?               // 说明文字
  description  String?  @db.Text     // 详细描述

  // 上传者
  uploaderId   String?
  uploader     User?    @relation(fields: [uploaderId], references: [id])

  // 关系
  featuredInPosts Post[]

  @@index([type])
  @@index([uploaderId])
  @@index([createdAt])
}

/// 媒体类型枚举
enum MediaType {
  IMAGE       // 图片
  VIDEO       // 视频
  AUDIO       // 音频
  DOCUMENT    // 文档
  ARCHIVE     // 压缩包
  OTHER       // 其他
}

// ============================================
// 评论系统
// ============================================

/// 评论表（支持嵌套评论）
model Comment {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 内容
  content   String   @db.Text

  // 作者（可以是游客）
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])

  // 游客信息（如果没有 authorId）
  guestName  String?  @db.VarChar(100)
  guestEmail String?  @db.VarChar(255)

  // 所属文章
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 嵌套评论（回复）
  parentId  String?
  parent    Comment?  @relation("CommentTree", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentTree")

  // 状态
  status    CommentStatus @default(PENDING)

  // IP 和 User Agent
  ipAddress String?
  userAgent String?  @db.Text

  @@index([postId])
  @@index([authorId])
  @@index([parentId])
  @@index([status])
  @@index([createdAt])
}

/// 评论状态枚举
enum CommentStatus {
  PENDING   // 待审核
  APPROVED  // 已批准
  REJECTED  // 已拒绝
  SPAM      // 垃圾评论
}

// ============================================
// 多语言系统
// ============================================

/// 语言表
model Language {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 语言信息
  code      String   @unique @db.VarChar(10)  // 如：zh-CN, en-US
  name      String   @db.VarChar(50)           // 如：简体中文, English
  nativeName String  @db.VarChar(50)           // 如：中文, English
  isDefault Boolean  @default(false)           // 是否默认语言
  isActive  Boolean  @default(true)            // 是否启用

  // 关系
  posts        Post[]
  translations PostTranslation[]

  @@index([code])
}

/// 文章翻译表
model PostTranslation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 原文章
  originalPostId String
  originalPost   Post   @relation(fields: [originalPostId], references: [id], onDelete: Cascade)

  // 语言
  languageId String
  language   Language @relation(fields: [languageId], references: [id])

  // 翻译内容
  title      String   @db.VarChar(255)
  slug       String   @unique
  excerpt    String?  @db.VarChar(500)
  content    String?  @db.Text

  @@unique([originalPostId, languageId])
  @@index([originalPostId])
  @@index([languageId])
  @@index([slug])
}

// ============================================
// 版本历史系统
// ============================================

/// 文章修订版本表
model PostRevision {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 所属文章
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 版本信息
  version   Int      // 版本号
  title     String   @db.VarChar(255)
  content   String?  @db.Text
  excerpt   String?  @db.VarChar(500)

  // 修改者
  authorId  String?
  author    User?    @relation(fields: [authorId], references: [id])

  // 变更说明
  changeLog String?  @db.Text

  @@index([postId])
  @@index([createdAt])
  @@unique([postId, version])
}

// ============================================
// 工作流审批系统
// ============================================

/// 审批请求表
model ApprovalRequest {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联文章
  postId    String   @unique
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 请求者
  requesterId String
  requester   User   @relation("Requester", fields: [requesterId], references: [id])

  // 状态
  status      ApprovalStatus @default(PENDING)

  // 备注
  notes       String?  @db.Text

  // 审批操作记录
  actions     ApprovalAction[]

  @@index([status])
  @@index([requesterId])
  @@index([createdAt])
}

/// 审批操作记录表
model ApprovalAction {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 审批请求
  requestId String
  request   ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // 操作者
  actorId   String
  actor     User     @relation(fields: [actorId], references: [id])

  // 操作
  action    ApprovalActionType
  comment   String?  @db.Text

  @@index([requestId])
  @@index([actorId])
  @@index([createdAt])
}

/// 审批状态枚举
enum ApprovalStatus {
  PENDING     // 待审批
  APPROVED    // 已批准
  REJECTED    // 已拒绝
  CANCELLED   // 已取消
}

/// 审批操作类型枚举
enum ApprovalActionType {
  SUBMITTED   // 提交审批
  APPROVED    // 批准
  REJECTED    // 拒绝
  REQUESTED_CHANGES  // 要求修改
  CANCELLED   // 取消
}

// ============================================
// 访问统计系统
// ============================================

/// 文章访问记录表
model PostView {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 文章
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  // 访问信息
  ipAddress String?
  userAgent String?  @db.Text
  referer   String?  @db.Text

  @@index([postId])
  @@index([createdAt])
}
